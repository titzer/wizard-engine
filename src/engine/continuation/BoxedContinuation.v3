// Copyright 2025 Wizard authors. All rights reserved.
// See LICENSE for details of Apache 2.0 license.

class Continuation extends Object {
	var stack: WasmStack;

	new(stack) { }

}

component Continuations {
	def NULL: Continuation = null;
	def valueKind = ValueKind.REF;
	def boxed = true;

	// write this as a component method since having it as a method on Continuation
	// leads to its use as a closure, which defeats unboxing in UnboxedContinuation
	def render(cont: Continuation, sb: StringBuilder) -> StringBuilder {
		return sb.put2("cont(isNull=%z,isUsed=%z)", Continuations.isNull(this), Continuations.isUsed(this));
	}

	def isNull(cont: Continuation) -> bool { return cont == null; }
	def isUsed(cont: Continuation) -> bool { return cont.stack == null; }
	def setUsed(cont: Continuation) { cont.stack = null; }

	def makeContinuation(stack: WasmStack) -> Continuation {
		return Continuation.new(stack);
	}

	def continuationWithVersion(stack: WasmStack, version: u64) -> Continuation {
		return makeContinuation(stack);
	}

	def getStoredStack(cont: Continuation) -> WasmStack { return cont.stack; }
	def getStoredVersion(cont: Continuation) -> u64 { return 0; } // boxed cont does not store version

	def getObject(cont: Continuation) -> Object { return cont; }
	def fromObject(obj: Exportable) -> Continuation { return Continuation.!(obj); }
}
